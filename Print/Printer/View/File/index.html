{//打印管理界面}
<extend name="Public/template/printerbase.html"/>
<block name='title'>{$title}</block>
<block name='header'>
<include file="./Public/template/printernav.html" manage="active"/>
</block>
<block name='content'>
<div class="title" >
    <h2>{$title}</h2>
</div>
<div class="container">
    <div class="row"><div class="col-lg-10">
    <div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th style="width:15%">待打印文件</th>
                <th>份数</th>
                <th>单双</th>
                <th>彩印</th>
                <th>PPT格式</th>
                <th>上传者</th>
                <th>上传时间</th>               
                <th>打印状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tablehead">
            <volist name="data" id="vo">
            <tr file_id="{$vo.id}">
                
                <td><a target='_blank' fid="{$vo.id}" class="download" href="__URL__/download/?fid={$vo.id}">[{$vo.id}]{$vo.name}</a></td>                
               
         <if condition="$vo.copies eq 0">
             <td>现打</td><td>-</td><td>-</td><td>-</td>    
      <else/>
            <td> {$vo.copies}</td><td>
                <if condition="$vo.double_side gt 0">
                双面
                <else/>
                单面
                </if>
                </td>
                <td>
                <if condition="$vo.color gt 0"> 彩印<else/>黑白</if>
                </td>
                <td>
                    {$vo.ppt_layout}
                </td>
            </if>
                <td>
                    <notempty name="vo['phone']">
                    <a tabindex="0" role="button" id="{$vo['id']}_phone" uid="{$vo['use_id']}" class="bind glyphicon glyphicon-phone" data-toggle="popover" data-trigger="focus" data-content="Loading..."></a>
                    </notempty>
                    {$vo.use_name}[{$vo.student_number}]
                </td>
                
                <td>{$vo.time}</td>               
                
                <td id="{$vo['id']}_status" data="{$vo['status']}" copies="{$vo['copies']}">
                    <switch name="vo['status']">
                    <case value="1">尚未下载</case>
                    <case value="2">已下载</case>
                    <case value="3">正在打印</case>
                    <case value="4">已印待付款</case>
                    <case value="5">已付款</case>
                    <default />未知状态
                    </switch>
                </td>
                
                
                <td>                    
                    <switch name="vo['status']">
                    <case value="1"><button type="button" id="{$vo.id}_button" fid='{$vo.id}' class="set btn btn-primary">通知已下载</button></case>
                    <case value="2" break="0"></case>
                    <case value="3"><button type="button" id="{$vo.id}_button" fid='{$vo.id}' class="set btn btn-success">通知已打印</button></case>
                    <case value="4"><button type="button" id="{$vo.id}_button" fid='{$vo.id}' class="set btn btn-warning">确认已付款</button></case>
                    <default />不可操作
                    </switch>                   
                </td>
                
                
            </tr>
            </volist>
        </tbody>
    </table>
    </div>
    </div></div>
</div>
</block>
<block name='end'>
<script>
$("table").on('click','.download',function(){
    var btn = $(this);
    var fid = btn.attr('fid');
    var status = $('#' + fid + '_status');
    var copies = status.attr('copies');
    status.html('已下载');    
    if(copies != 0 )
    {
        status.attr('data', 2);
        $('#' + fid + '_button').html('通知已打印').removeClass("btn btn-primary").addClass("btn btn-success");
    }
    else
    {
        status.attr('data', 4);
        $('#' + fid + '_button').html('确认已付款').removeClass("btn btn-success").addClass("btn btn-warning");
    }
});


$("table").on('click', '.set', function() {
    var URL = "/Printer/File/set";
    var btn = $(this);
    btn.attr('disabled','disabled');
    var fid = btn.attr('fid');
    var status = $('#' + fid + '_status');
    var copies = status.attr('copies');
    var set_s = 1 + parseInt(status.attr('data'));
    if (set_s == 3) {
        set_s = 1 + set_s;
    }
    if (copies ==0 && set_s==2)
    {
        set_s = 4;
    }
    $.post(URL, {
        fid: fid,
        status: set_s
    }, function(data) {
        if (data.status) {
            status.attr('data', set_s);
            if (set_s == 4) {
                btn.html('确认已付款').removeClass("btn btn-success").addClass("btn btn-warning");
                status.html('已打印');
            } else if (set_s == 2) {
                $('#' + fid + '_button').html('通知已打印').removeClass("btn btn-primary").addClass("btn btn-success");
                status.html('已下载');
            } else {
                btn.parent().parent().hide(1600);
            }
        } else {
            alert(data.info);
        }
    });
    btn.removeAttr('disabled');
});

function insert(data)
{
    var trLast = $('tr:last').clone();
    trLast.attr('file_id',data.id);
    
    var node = trLast.find('a').eq(0);
    node.attr('fid',data.id);
    node.attr('href',"/Printer/File/download/?fid="+data.id);
    node.html('['+data.id+']'+data.name);
    
    node = trLast.find('td').eq(1);
    if(data.copies==0)
    {
        node.html('现打');
    }
    else
    {
        node.html(data.copies);
    }
    var double_side = new Array("单面","双面"); 
    node = trLast.find('td').eq(2);
    node.html(double_side[data.double_side]);
    var color = new Array("黑白","彩色");
    node = trLast.find('td').eq(3);
    node.html(color[data.color]);

    node = trLast.find('td').eq(4);
    node.html(data.ppt_layout);

    node = trLast.find('a')[1];
    if((typeof node === 'undefined')&&data.phone)
    {
        var html = '<a tabindex="0" role="button" id="'+data.id+'_phone" uid="'+data.use_id+'" class="bind glyphicon glyphicon-phone" data-toggle="popover" data-trigger="focus" data-content="Loading..."></a>';
        trLast.find('td').eq(5).append(html);
    }
    else if((typeof data.phone === 'undefined')&&node)
    {
        node.remove();
    }
    node = trLast.find('td').eq(5);
    node.html(data.use_name+'['+data.student_number+']');
    
    node = trLast.find('td').eq(6);
    node.html(data.time);
    
    var f_status = new Array("未知状态","尚未下载","已下载","已下载","已印待付款");
    node = trLast.find('td').eq(7);
    node.attr('id',data.id+'_status');
    node.attr('data',data.status);
    node.attr('copies',data.copies);
    node.html(f_status[data.status]);
    
    var b_class = new Array("btn btn-success","btn btn-primary","btn btn-success","btn btn-success","btn btn-danger");
    var b_status = new Array("不可操作","通知已下载","通知已打印","通知已打印","确认已付款");
    node = trLast.find('button');
    node.attr('id',data.id+'_button');
    node.attr('fid',data.id);
    node.removeClass().addClass(b_class[data.status]);
    node.html(b_status[data.status]);
    $('tbody').prepend(trLast);
}


phoneIsLoad = 0;
$("table").on('click', '.bind', function(e) {
    var URL = "/Printer/File/bind";
    var btn = $(this);
    var uid = btn.attr('uid');
    if(phoneIsLoad == 0)
    {
        $('[data-toggle="popover"]').popover();
        $.get(URL, {
            uid : uid 
        }, function(data) {
            if (data.status) {
                btn.attr('data-content',data.info);
                btn.popover('show');
            }
        });
        phoneIsLoad = 1;
    }
});

isRefreshing = false;

function refresh() {
    if (isRefreshing) {
        return;
    } else {
        isRefreshing = true;
    }
    var file_id = $('tbody').children().attr('file_id');
    var url = "__URL__/refresh";
    $.post(url, {
        file_id: 208
    }, function(data) {
        if (data.status) {
            for(var key in data.info)
            {
                insert(data.info[key]);
            }
            var html='<div class="alert alert-warning" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span></button><span class="text-danger">新文件到达</span></div>';
            $('main').prepend(html);
        }
        isRefreshing = false;
    });
}
$(document).ready(function() {
    //setInterval(refresh, 15000);
    refresh();
});
</script>
</block>
